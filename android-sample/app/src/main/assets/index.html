<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Sample</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .output {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status.ready {
            background: #10b981;
            color: white;
        }
        
        .status.error {
            background: #ef4444;
            color: white;
        }
        
        .event-log {
            background: #1e293b;
            color: #10b981;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .event-log .timestamp {
            color: #64748b;
        }
        
        .event-log .event {
            color: #f59e0b;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 480px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåâ JavaScript Bridge</h1>
        <p class="subtitle">Android WebView ‚Üî Native Communication Demo</p>
        
        <div class="card">
            <h2>
                Bridge Status
                <span id="bridgeStatus" class="status">Checking...</span>
            </h2>
            <p style="font-size: 14px; color: #666;">
                Version: <strong id="bridgeVersion">-</strong><br>
                Platform: <strong id="platform">-</strong>
            </p>
        </div>
        
        <div class="card">
            <h2>üì± Device Info (Request-Response)</h2>
            <button onclick="getDeviceInfo()">Get Device Info</button>
            <div id="deviceInfoOutput" class="output" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üí¨ Toast Messages (Fire-and-Forget)</h2>
            <div class="grid">
                <button onclick="showToast('Hello from WebView!', 'short')">Show Short Toast</button>
                <button onclick="showToast('This is a longer message!', 'long')">Show Long Toast</button>
            </div>
        </div>
        
        <div class="card">
            <h2>üìä Analytics (Fire-and-Forget)</h2>
            <div class="grid">
                <button onclick="trackEvent('button_click', { button: 'track_1' })">Track Event 1</button>
                <button onclick="trackEvent('page_view', { page: 'demo' })">Track Event 2</button>
            </div>
        </div>
        
        <div class="card">
            <h2>üîê Secure Storage (Request-Response)</h2>
            <button onclick="saveData()">Save Secure Data</button>
            <button onclick="loadData()">Load Secure Data</button>
            <div id="storageOutput" class="output" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üéØ Permission Request (Request-Response)</h2>
            <button onclick="requestPermission('camera')">Request Camera</button>
            <button onclick="requestPermission('location')">Request Location</button>
            <div id="permissionOutput" class="output" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>üì® Native ‚Üí Web Events</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                Events received from native code:
            </p>
            <div id="eventLog" class="event-log">Waiting for events...</div>
        </div>
        
        <div class="card">
            <h2>üåê Network & Settings</h2>
            <div class="grid">
                <button onclick="getNetworkStatus()">Network Status</button>
                <button onclick="openSettings()">Open Settings</button>
            </div>
        </div>
        
        <div class="card">
            <h2>‚öôÔ∏è Advanced Features</h2>
            <button onclick="testTimeout()">Test Timeout (5s)</button>
            <button onclick="testErrorHandling()">Test Error Handling</button>
            <button onclick="toggleDebug()">Toggle Debug Mode</button>
            <div id="advancedOutput" class="output" style="display: none;"></div>
        </div>
    </div>

    <!-- Load bridge -->
    <script src="bridge.js"></script>
    
    <script>
        // Event log
        const eventLog = [];
        
        function logEvent(message) {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.unshift(`<span class="timestamp">[${timestamp}]</span> ${message}`);
            if (eventLog.length > 20) eventLog.pop();
            document.getElementById('eventLog').innerHTML = eventLog.join('<br>');
        }
        
        function showOutput(elementId, content, isError = false) {
            const output = document.getElementById(elementId);
            output.style.display = 'block';
            output.style.background = isError ? '#fee2e2' : '#f7f7f7';
            output.style.color = isError ? '#991b1b' : '#333';
            output.textContent = typeof content === 'object' 
                ? JSON.stringify(content, null, 2) 
                : content;
        }
        
        // Initialize bridge
        async function init() {
            console.log('Initializing bridge demo...');
            
            // Check if bridge exists
            if (!window.bridge) {
                document.getElementById('bridgeStatus').textContent = 'Not Available';
                document.getElementById('bridgeStatus').className = 'status error';
                console.error('Bridge not available!');
                return;
            }
            
            // Wait for bridge to be ready
            await window.bridge.ready();
            
            // Update status
            document.getElementById('bridgeStatus').textContent = 'Ready';
            document.getElementById('bridgeStatus').className = 'status ready';
            document.getElementById('bridgeVersion').textContent = window.bridge.version;
            
            // Enable debug mode
            window.bridge.setDebug(true);
            
            logEvent('Bridge initialized');
            
            // Get initial device info
            try {
                const info = await window.bridge.call({
                    data: { action: 'getDeviceInfo' }
                });
                document.getElementById('platform').textContent = 
                    `${info.platform} ${info.osVersion} (${info.manufacturer} ${info.model})`;
                logEvent(`Platform: ${info.platform} ${info.osVersion}`);
            } catch (error) {
                console.error('Error getting device info:', error);
            }
            
            // Register handler for incoming messages from native
            window.bridge.on(async (message) => {
                const { action, content } = message.data;
                logEvent(`<span class="event">Event:</span> ${action}`);
                
                switch (action) {
                    case 'nativeEvent':
                        console.log('Received native event:', content);
                        logEvent(`Native says: ${content.message}`);
                        return; // No response needed
                        
                    case 'getWebState':
                        // Request-response: native wants data from web
                        logEvent(`Native requested web state`);
                        return {
                            url: window.location.href,
                            scrollY: window.scrollY,
                            timestamp: Date.now()
                        };
                        
                    case 'appStateChanged':
                        logEvent(`App state: ${content.state}`);
                        return;
                        
                    default:
                        logEvent(`Unknown action: ${action}`);
                        return { 
                            error: { 
                                code: 'UNKNOWN_ACTION', 
                                message: `Unknown action: ${action}` 
                            } 
                        };
                }
            });
            
            logEvent('Message handler registered');
        }
        
        // Device Info
        async function getDeviceInfo() {
            try {
                logEvent('Requesting device info...');
                const result = await window.bridge.call({
                    data: { action: 'getDeviceInfo' }
                });
                showOutput('deviceInfoOutput', result);
                logEvent('Device info received');
            } catch (error) {
                showOutput('deviceInfoOutput', `Error: ${error.message}`, true);
                logEvent(`Error: ${error.message}`);
            }
        }
        
        // Toast Messages (Fire-and-Forget)
        function showToast(message, duration) {
            logEvent(`Showing toast: ${message}`);
            window.bridge.call({
                data: {
                    action: 'showToast',
                    content: { message, duration }
                }
            });
            // Note: No await! This is fire-and-forget
        }
        
        // Analytics (Fire-and-Forget)
        function trackEvent(eventName, properties) {
            logEvent(`Tracking: ${eventName}`);
            window.bridge.call({
                data: {
                    action: 'trackEvent',
                    content: { event: eventName, properties }
                }
            });
            // Note: No await! This is fire-and-forget
        }
        
        // Secure Storage
        async function saveData() {
            try {
                logEvent('Saving secure data...');
                const result = await window.bridge.call({
                    data: {
                        action: 'setSecureData',
                        content: {
                            key: 'demo_key',
                            value: 'secret_value_' + Date.now()
                        }
                    }
                });
                showOutput('storageOutput', 'Data saved successfully!');
                logEvent('Data saved');
            } catch (error) {
                showOutput('storageOutput', `Error: ${error.message}`, true);
            }
        }
        
        async function loadData() {
            try {
                logEvent('Loading secure data...');
                const result = await window.bridge.call({
                    data: {
                        action: 'getSecureData',
                        content: { key: 'demo_key' }
                    }
                });
                showOutput('storageOutput', result);
                logEvent('Data loaded');
            } catch (error) {
                showOutput('storageOutput', `Error: ${error.message}`, true);
            }
        }
        
        // Permissions
        async function requestPermission(permission) {
            try {
                logEvent(`Requesting ${permission} permission...`);
                const result = await window.bridge.call({
                    data: {
                        action: 'requestPermission',
                        content: { permission }
                    }
                });
                showOutput('permissionOutput', result);
                logEvent(`Permission ${result.granted ? 'granted' : 'denied'}`);
            } catch (error) {
                showOutput('permissionOutput', `Error: ${error.message}`, true);
            }
        }
        
        // Network & Settings
        async function getNetworkStatus() {
            try {
                logEvent('Getting network status...');
                const result = await window.bridge.call({
                    data: { action: 'getNetworkStatus' }
                });
                showOutput('advancedOutput', result);
                logEvent(`Network: ${result.online ? 'Online' : 'Offline'} (${result.type})`);
            } catch (error) {
                showOutput('advancedOutput', `Error: ${error.message}`, true);
            }
        }
        
        async function openSettings() {
            try {
                logEvent('Opening app settings...');
                await window.bridge.call({
                    data: { action: 'openSettings' }
                });
                logEvent('Settings opened');
            } catch (error) {
                showOutput('advancedOutput', `Error: ${error.message}`, true);
            }
        }
        
        // Advanced Features
        async function testTimeout() {
            try {
                logEvent('Testing timeout (this will fail)...');
                const result = await window.bridge.call({
                    data: {
                        action: 'slowOperation',
                        content: {}
                    }
                }, { timeout: 5000 });
                showOutput('advancedOutput', result);
            } catch (error) {
                showOutput('advancedOutput', `Expected timeout: ${error.message}`, false);
                logEvent('Timeout handled correctly');
            }
        }
        
        async function testErrorHandling() {
            try {
                logEvent('Testing error handling...');
                const result = await window.bridge.call({
                    data: {
                        action: 'unknownAction',
                        content: {}
                    }
                });
                showOutput('advancedOutput', result);
            } catch (error) {
                showOutput('advancedOutput', `Expected error: ${error.message}`, false);
                logEvent('Error handled correctly');
            }
        }
        
        let debugEnabled = true;
        function toggleDebug() {
            debugEnabled = !debugEnabled;
            window.bridge.setDebug(debugEnabled);
            showOutput('advancedOutput', `Debug mode: ${debugEnabled ? 'ON' : 'OFF'}`);
            logEvent(`Debug mode: ${debugEnabled ? 'ON' : 'OFF'}`);
        }
        
        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>

